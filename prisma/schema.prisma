// WatchMyLinks Database Schema
// Prisma schema for PostgreSQL (Vercel Postgres)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLED")
}

// Enums
enum Platform {
  YOUTUBE
  INSTAGRAM
  TIKTOK
}

enum LinkStatus {
  WORKING
  BROKEN
  REDIRECT
  TIMEOUT
  UNKNOWN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INCOMPLETE
  FREE
}

// Models
model User {
  id                   String              @id @default(cuid())
  email                String              @unique
  name                 String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  
  // Stripe billing
  stripeCustomerId     String?             @unique
  stripeSubscriptionId String?             @unique
  subscriptionStatus   SubscriptionStatus  @default(FREE)
  subscriptionEndsAt   DateTime?
  
  channels  Channel[]
  links     Link[]
  
  @@map("users")
}

model Channel {
  id              String   @id @default(cuid())
  userId          String
  platform        Platform
  channelId       String   // YouTube/Instagram/TikTok channel ID
  channelName     String
  channelHandle   String?  // @username
  avatarUrl       String?
  subscriberCount Int?
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  links           Link[]
  
  @@unique([userId, platform, channelId])
  @@map("channels")
}

model Link {
  id                String     @id @default(cuid())
  channelId         String
  userId            String
  affiliateProvider String     // "Amazon Associates", "ClickBank", etc.
  productName       String
  affiliateUrl      String     // Original affiliate link
  destinationUrl    String?    // Final destination after redirects
  status            LinkStatus @default(UNKNOWN)
  lastChecked       DateTime?
  clicks            Int        @default(0)
  revenue           Float      @default(0)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  channel           Channel    @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  checks            LinkCheck[]
  
  @@map("links")
}

model LinkCheck {
  id           String     @id @default(cuid())
  linkId       String
  status       LinkStatus
  statusCode   Int?       // HTTP status code
  responseTime Int?       // Response time in ms
  errorMessage String?
  checkedAt    DateTime   @default(now())
  
  link         Link       @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  @@index([linkId, checkedAt])
  @@map("link_checks")
}
